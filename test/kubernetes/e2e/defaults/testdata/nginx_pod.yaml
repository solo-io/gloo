---
apiVersion: v1
kind: Namespace
metadata:
  name: nginx
---
apiVersion: v1
kind: Service
metadata:
  name: nginx
  namespace: nginx
spec:
  selector:
    app.kubernetes.io/name: nginx
  ports:
    - protocol: TCP
      port: 8080
      targetPort: http-web-svc
      name: http
    - protocol: TCP
      port: 8443
      targetPort: https-web-svc
      name: https
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-conf
  namespace: nginx
data:
  nginx.conf: |
    user nginx;
    worker_processes  1;
    events {
      worker_connections  10240;
    }
    http {
      server {
          listen              80;
          listen              443 ssl;
          server_name         localhost nginx nginx.nginx nginx.nginx.svc nginx.nginx.svc.cluster.local;
          ssl_certificate     /etc/nginx/tls/tls.crt;
          ssl_certificate_key /etc/nginx/tls/tls.key;

          location / {
            root   /usr/share/nginx/html;
            index  index.html index.htm;
        }
      }
    }
---
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  namespace: nginx
  labels:
    app.kubernetes.io/name: nginx
spec:
  containers:
    - name: nginx
      image: nginx:stable
      ports:
        - containerPort: 80
          name: http-web-svc
        - containerPort: 443
          name: https-web-svc
      resources:
        requests:
          cpu: "100m"
        limits:
          cpu: "200m"
      volumeMounts:
        - name: nginx-conf
          mountPath: /etc/nginx/nginx.conf
          subPath: nginx.conf
          readOnly: true
        - name: nginx-tls
          mountPath: /etc/nginx/tls/
          readOnly: true
  volumes:
    - name: nginx-conf
      configMap:
        name: nginx-conf
    - name: nginx-tls
      secret:
        secretName: nginx-tls
